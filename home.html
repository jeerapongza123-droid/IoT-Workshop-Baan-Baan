<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>IoT SMART HOME DASHBOARD</title>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --danger-color: #e74a3b;
            --bg-color: #f4f7fe;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --text-muted: #636e72;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            --radius-lg: 24px;
            --radius-md: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        /* Development Mode Badge */
        .dev-badge {
            background: rgba(231, 74, 59, 0.1);
            color: var(--danger-color);
            padding: 5px 15px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            margin-top: 15px;
            border: 1px solid rgba(231, 74, 59, 0.2);
            letter-spacing: 1px;
        }

        /* Status Header */
        .header-status {
            width: 90%;
            max-width: 500px;
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .status-badge {
            background: var(--card-bg);
            padding: 15px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow);
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Nav Bar */
        nav.main-nav {
            display: flex;
            gap: 12px;
            margin: 20px 0;
            width: 90%;
            max-width: 500px;
        }

        .btn-nav {
            flex: 1;
            background: var(--card-bg);
            border: none;
            padding: 14px;
            border-radius: var(--radius-md);
            font-family: 'Prompt';
            font-weight: 500;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: 0.3s;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-nav:active {
            transform: scale(0.95);
        }

        .btn-nav.active {
            background: var(--primary-color);
            color: white;
        }

        #app {
            width: 90%;
            max-width: 500px;
            padding-bottom: 40px;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .card-title {
            font-weight: 600;
            font-size: 17px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary-color);
        }

        /* Buttons Style */
        .action-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: var(--radius-md);
            font-family: 'Prompt';
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 12px;
            background: #f8f9fc;
            color: var(--text-main);
        }

        .action-btn:active {
            transform: scale(0.97);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 8px 20px rgba(78, 115, 223, 0.2);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            box-shadow: 0 8px 20px rgba(28, 200, 138, 0.2);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
            box-shadow: 0 8px 20px rgba(231, 74, 59, 0.2);
        }

        .btn-outline-danger {
            background: transparent;
            border: 2px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Status Indicator Text */
        .status-text {
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            padding: 12px;
            border-radius: var(--radius-md);
            background: #f8f9fc;
            margin: 5px 0 20px 0;
            border: 1px solid #edf2f7;
        }

        /* Days Grid */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-box {
            background: #f8f9fc;
            padding: 10px 5px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid #eee;
        }

        .day-btn {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: none;
            background: #fff;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            font-weight: 700;
            font-size: 10px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .day-status {
            font-size: 11px;
            font-weight: 700;
        }

        /* Time Input */
        input[type="time"] {
            width: 100%;
            padding: 15px;
            border-radius: var(--radius-md);
            border: 2px solid #edf2f7;
            margin-bottom: 15px;
            font-family: 'Prompt';
            text-align: center;
            font-size: 26px;
            font-weight: 700;
            color: var(--primary-color);
            background: #f8f9fc;
        }

        .label-mini {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
            padding-left: 5px;
        }
    </style>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        /* ฟังก์ชันดึงเวลาปัจจุบันใส่ในช่อง Input */
        function setCurrentTime() {
            setTimeout(() => {
                const now = new Date();
                const timeStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                if (document.getElementById('settime1')) document.getElementById('settime1').value = timeStr;
                if (document.getElementById('settime2')) document.getElementById('settime2').value = timeStr;
            }, 100);
        }

        /* === JAVA SCRIPT LOGIC (คงเดิม 100%) === */
        window.addEventListener('DOMContentLoaded', () => {
            const isLoggedIn = sessionStorage.getItem("isLoggedIn");
            if (!isLoggedIn || isLoggedIn !== "true") {
                window.location.href = "index.html";
                return;
            }
            connect();
        });

        function go(page) {
            const app = document.getElementById('app');
            localStorage.setItem('currentPage', page);
            if (page === 'home') {
                app.innerHTML = `
                    <div class="card">
                        <div class="card-title"><i class="fas fa-th-large"></i> ฟังก์ชันการทำงาน</div>
                        <button class="action-btn" onclick="go('setting1')">
                            <div style="background:rgba(78, 115, 223, 0.1); width:45px; height:45px; border-radius:12px; display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-clock" style="color:var(--primary-color); font-size:20px;"></i>
                            </div>
                            <div style="text-align:left; flex-grow:1;">
                                <span style="display:block; font-size:15px;">ตั้งค่าโปรแกรม 1</span>
                                <small style="color:var(--text-muted); font-weight:400;">จัดการเวลาเปิด-ปิดอัตโนมัติ</small>
                            </div>
                            <i class="fas fa-chevron-right" style="font-size:12px; opacity:0.3;"></i>
                        </button>
                    </div>
                `;
            } else if (page === 'setting1') {
                connect();
                app.innerHTML = `
                    <div class="card">
                        <div class="card-title"><i class="fas fa-sliders-h"></i> ควบคุมอุปกรณ์</div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
                            <button class="action-btn btn-primary" onclick="refresh()"><i class="fas fa-sync"></i> รีเฟรช</button>
                            <button class="action-btn btn-outline-danger" onclick="reset('esp32/Resetp1')"><i class="fas fa-power-off"></i> รีเซ็ต</button>
                        </div>
                        
                        <label class="label-mini">โหมดการทำงาน:</label>
                        <button class="action-btn" onclick="send_mqtt_interlock('/pro_Gram-1','1')">
                            <i class="fas fa-robot" style="font-size:20px; color:var(--primary-color)"></i>
                            <span>Auto Program 1</span>
                        </button>
                        <p id="setp1" class="status-text">กำลังโหลด...</p>

                        <button class="action-btn" onclick="send_mqtt_interlock('/esp_c','ON')">
                            <i class="fas fa-hand-pointer" style="font-size:20px; color:var(--primary-color)"></i>
                            <span>Manual Control</span>
                        </button>
                        <p id="/Status" class="status-text">กำลังโหลด...</p>
                    </div>

                    <div class="card">
                        <div class="card-title" style="color:var(--success-color)"><i class="fas fa-plus-circle"></i> ตั้งเวลาเปิด (Timer ON)</div>
                        <div class="days-grid">
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Sun','7')">อา.</button><div id="/Sun" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Mon','1')">จ.</button><div id="/Mon" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Tue','2')">อ.</button><div id="/Tue" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Wed','3')">พ.</button><div id="/Wed" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Thu','4')">พฤ.</button><div id="/Thu" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Fri','5')">ศ.</button><div id="/Fri" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Sat','6')">ส.</button><div id="/Sat" class="day-status">--</div></div>
                        </div>
                        <input id="settime1" type="time">
                        <button class="action-btn btn-success" onclick="set_time('/relay2', document.getElementById('settime1').value)">
                            <i class="fas fa-save"></i> บันทึกเวลาเปิด
                        </button>
                        <p id="/setok" class="status-text">Waiting...</p>
                    </div>

                    <div class="card">
                        <div class="card-title" style="color:var(--danger-color)"><i class="fas fa-minus-circle"></i> ตั้งเวลาปิด (Timer OFF)</div>
                        <div class="days-grid">
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Sun_Set_off','7')">อา.</button><div id="/Sun_off" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Mon_Set_off','1')">จ.</button><div id="/Mon_off" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Tue_Set_off','2')">อ.</button><div id="/Tue_off" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Wed_Set_off','3')">พ.</button><div id="/Wed_off" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Thu_Set_off','4')">พฤ.</button><div id="/Thu_off" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Fri_Set_off','5')">ศ.</button><div id="/Fri_off" class="day-status">--</div></div>
                            <div class="day-box"><button class="day-btn" onclick="send_mqtt_interlock('/Sat_Set_off','6')">ส.</button><div id="/Sat_off" class="day-status">--</div></div>
                        </div>
                        <input id="settime2" type="time">
                        <button class="action-btn btn-danger" onclick="set_time('/relay3', document.getElementById('settime2').value)">
                            <i class="fas fa-save"></i> บันทึกเวลาปิด
                        </button>
                        <p id="/setokk" class="status-text">Waiting...</p>
                    </div>
                `;
                setCurrentTime();
            }
        }

        function updateStatusColor(id, text) {
            const el = document.getElementById(id);
            if (!el) return;
            el.innerText = text;

            // Logic เปลี่ยนสี เขียว-แดง
            if (text.includes("ON") || text.includes("Online") || text.includes("Set ON")) {
                el.style.color = "var(--success-color)";
                el.style.borderColor = "var(--success-color)";
                el.style.background = "rgba(28, 200, 138, 0.05)";
            } else if (text.includes("Off") || text.includes("OFF") || text.includes("Offline")) {
                el.style.color = "var(--danger-color)";
                el.style.borderColor = "var(--danger-color)";
                el.style.background = "rgba(231, 74, 59, 0.05)";
            } else {
                el.style.color = "var(--text-muted)";
                el.style.background = "#f8f9fc";
            }
        }

        /* MQTT LOGIC */
        function refresh() { setTimeout(() => { send_mqtt('/Repro1', '1'); send_mqtt('/Repro1', '0'); }, 100); }
        function reset(data_Reset) { if (data_Reset === 'esp32/Resetp1') { setTimeout(() => { send_mqtt('esp32/Resetp1', '1'); send_mqtt('esp32/Resetp1', '0'); }, 100); } }
        function set_time(topic, payl) { if (!payl) return; client.publish(topic, payl); }
        function logout() { sessionStorage.clear(); localStorage.clear(); window.location.href = "index.html"; }

        window.addEventListener('DOMContentLoaded', () => {
            const page = localStorage.getItem('currentPage') || 'home';
            go(page);
        });

        var client;
        function connect() {
            const brokerUrl = 'wss://broker.hivemq.com:8884/mqtt';
            const options = { keepalive: 60, clientId: 'web_' + Math.random().toString(16).substr(2, 8) };
            client = mqtt.connect(brokerUrl, options);
            client.on('connect', () => {
                const st = document.getElementById('status');
                st.innerHTML = '<i class="fas fa-circle" style="font-size:8px"></i> MQTT: Connected';
                st.style.color = "var(--success-color)";
                client.subscribe('/node'); client.subscribe('set-p1-ok');
                client.subscribe('/Status'); client.subscribe('/Sun_on');
                client.subscribe("/Mon_on"); client.subscribe("/Tue_on");
                client.subscribe("/Wed_on"); client.subscribe("/Thu_on");
                client.subscribe("/Fri_on"); client.subscribe("/Sat_on");
                client.subscribe('/Sun_Status_on'); client.subscribe('/Mon_Status_on');
                client.subscribe('/Tue_Status_on'); client.subscribe('/Wed_Status_on');
                client.subscribe('/Thu_Status_on'); client.subscribe('/Fri_Status_on');
                client.subscribe('/Sat_Status_on'); client.subscribe('/setok'); client.subscribe('/setokk');
            });

            client.on('message', (topic, message) => {
                let msg = message.toString();
                if (topic === '/node') updateStatusColor('esp_online', msg === '1' ? 'ESP: Online' : 'ESP: Offline');
                if (topic === 'set-p1-ok') { updateStatusColor('setp1', msg === '1' ? 'Status Program 1 ON' : 'Status Program 1 OFF'); a = (msg === '1') ? 1 : 0; }
                if (topic === '/Status') { updateStatusColor('/Status', msg === '1' ? 'Status Relay ON' : 'Status Relay OFF'); b = (msg === '1') ? 1 : 0; }
                const daysOn = { '/Sun_on': '/Sun', '/Mon_on': '/Mon', '/Tue_on': '/Tue', '/Wed_on': '/Wed', '/Thu_on': '/Thu', '/Fri_on': '/Fri', '/Sat_on': '/Sat' };
                if (daysOn[topic]) updateStatusColor(daysOn[topic], msg === '1' ? 'ON' : 'Off');
                const daysOff = { '/Sun_Status_on': '/Sun_off', '/Mon_Status_on': '/Mon_off', '/Tue_Status_on': '/Tue_off', '/Wed_Status_on': '/Wed_off', '/Thu_Status_on': '/Thu_off', '/Fri_Status_on': '/Fri_off', '/Sat_Status_on': '/Sat_off' };
                if (daysOff[topic]) updateStatusColor(daysOff[topic], msg === '1' ? 'ON' : 'Off');
                if (topic === '/setok') updateStatusColor('/setok', msg === '1' ? 'Time Set ON' : 'Loading');
                if (topic === '/setokk') updateStatusColor('/setokk', msg === '1' ? 'Time Set ON' : 'Loading');
            });
        }
        function send_mqtt(topic, mass) { client.publish(topic, mass); }
        var a = null, b = null, Sun = 0, Mon = 0, Tue = 0, Wed = 0, Thu = 0, Fri = 0, Sat = 0;
        var Sun_off = 0, Mon_off = 0, Tue_off = 0, Wed_off = 0, Thu_off = 0, Fri_off = 0, Sat_off = 0;

        function send_mqtt_interlock(send_mqtt1, mass1) {
            if (send_mqtt1 === '/pro_Gram-1') {
                if (mass1 === '1' && a === 0) { a = 1; return client.publish(send_mqtt1, mass1, { retain: true }); }
                if (mass1 === '1' && a === 1) { mass1 = '0'; a = 0; return client.publish(send_mqtt1, mass1, { retain: true }); }
            }
            if (send_mqtt1 === '/esp_c') {
                if (mass1 === 'ON' && b === 0) { b = 1; return client.publish(send_mqtt1, mass1, { retain: true }); }
                if (b === 1 && mass1 === 'ON') { mass1 = 'OFF'; b = 0; return client.publish(send_mqtt1, mass1, { retain: true }); }
            }
            if (send_mqtt1 === '/Sun') { if (mass1 === '7' && Sun === 0) { Sun = 7; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '7' && Sun === 7) { mass1 = '0'; Sun = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Mon') { if (mass1 === '1' && Mon === 0) { Mon = 1; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '1' && Mon === 1) { mass1 = '0'; Mon = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Tue') { if (mass1 === '2' && Tue === 0) { Tue = 2; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '2' && Tue === 2) { mass1 = '0'; Tue = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Wed') { if (mass1 === '3' && Wed === 0) { Wed = 3; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '3' && Wed === 3) { mass1 = '0'; Wed = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Thu') { if (mass1 === '4' && Thu === 0) { Thu = 4; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '4' && Thu === 4) { mass1 = '0'; Thu = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Fri') { if (mass1 === '5' && Fri === 0) { Fri = 5; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '5' && Fri === 5) { mass1 = '0'; Fri = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Sat') { if (mass1 === '6' && Sat === 0) { Sat = 6; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '6' && Sat === 6) { mass1 = '0'; Sat = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Sun_Set_off') { if (mass1 === '7' && Sun_off === 0) { Sun_off = 7; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '7' && Sun_off === 7) { mass1 = '0'; Sun_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Mon_Set_off') { if (mass1 === '1' && Mon_off === 0) { Mon_off = 1; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '1' && Mon_off === 1) { mass1 = '0'; Mon_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Tue_Set_off') { if (mass1 === '2' && Tue_off === 0) { Tue_off = 2; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '2' && Tue_off === 2) { mass1 = '0'; Tue_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Wed_Set_off') { if (mass1 === '3' && Wed_off === 0) { Wed_off = 3; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '3' && Wed_off === 3) { mass1 = '0'; Wed_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Thu_Set_off') { if (mass1 === '4' && Thu_off === 0) { Thu_off = 4; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '4' && Thu_off === 4) { mass1 = '0'; Thu_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Fri_Set_off') { if (mass1 === '5' && Fri_off === 0) { Fri_off = 5; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '5' && Fri_off === 5) { mass1 = '0'; Fri_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
            if (send_mqtt1 === '/Sat_Set_off') { if (mass1 === '6' && Sat_off === 0) { Sat_off = 6; return client.publish(send_mqtt1, mass1, { retain: true }); } if (mass1 === '6' && Sat_off === 6) { mass1 = '0'; Sat_off = 0; return client.publish(send_mqtt1, mass1, { retain: true }); } }
        }
    </script>
</head>

<body>
    <div class="dev-badge">DEVELOPMENT MODE</div>

    <div class="header-status">
        <div class="status-badge" id="status" style="color:var(--text-muted)">
            <i class="fas fa-circle-notch fa-spin"></i> MQTT: Checking
        </div>
        <div class="status-badge" id="esp_online" style="color:var(--text-muted)">
            <i class="fas fa-microchip"></i> ESP: Checking
        </div>
    </div>

    <nav class="main-nav">
        <button class="btn-nav" onclick="go('home')">
            <i class="fas fa-home"></i> <span>หน้าหลัก</span>
        </button>
        <button class="btn-nav" onclick="logout()" style="color:var(--danger-color)">
            <i class="fas fa-sign-out-alt"></i> <span>ออกระบบ</span>
        </button>
    </nav>

    <div id="app"></div>

</body>

</html>